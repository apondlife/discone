#!/bin/sh

# run this script from the project root; a portable way of getting
# a script's path is hard to come by, so we assume .env is in the cwd

# -- includes --
. bin/prelude

# -- props --
# the variant (e.g. playtest, release) if any; defaults to release
VARIANT=""

# the target (e.g. mac, win, win-server) if any; defaults to all
TARGET=""

# -- parsing --
Usage() {
  pu "[-h] [-v <variant>] [-t <target>]"
}

while getopts ":hv:t:" option; do
  case "${option}" in
    h*) Usage ;;
    v*) VARIANT="$OPTARG" ;;
    t*) TARGET="$OPTARG" ;;
  esac
done

# -- commands --
# create .env in missing
CheckEnv() {
  if [ ! -f .env ]; then
    if [ ! -f .env.sample ]; then
      pe "you need a .env (and a .env.sample to create it from)"
      pi "run this script from the project root, e.g."
      pl "> ./bin/build"
      exit 2
    fi

    pi "creating .env from .env.sample; fill it out and try again"
    cp .env.sample .env

    exit 3
  fi
}

# ensure a clean git state
CheckStatus() {
  if [ -n "$(git status --porcelain)" ]; then
    pf 3 "there are uncommitted changes! this could lead to an unstable build: please commit, stash, &c."
  fi
}

# build the targets
Build() {
  pl "starting build (see: Assets/Editor/Builds/BuildAll.cs)"
  pl "~*~ ~*~ ~*~"

  # os-specific options
  case "$OS" in
    mac) opts="-logFile - " ;;
    win) opts="-logFile - stdout" ;;
  esac

  # run the build script
  "$UNITY_PATH" \
    -quit \
    -batchmode \
    -projectPath . \
    $opts \
    -executeMethod Builds.BuildAll.Main \
    -- \
    --variant "$VARIANT" \
    --target "$TARGET"

  ps "build complete"
}

# -- main --
Main() {
  FindOs

  # validate environment
  CheckEnv
  CheckStatus

  # load env
  LoadEnv

  # validate env
  if [ ! -f "$UNITY_PATH" ]; then
    pf 4 "unity (.env->UNITY_PATH) does not exist at '$UNITY_PATH'"
  fi

  if ps x | grep -v grep | grep "$UNITY_PATH -projectpath .*discone" > /dev/null; then
    pf 5 "unity is running! the build script can't run when unity is open"
  fi

  # run build
  Build
}

Main "$*"
