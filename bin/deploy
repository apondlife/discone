#!/bin/sh
set -x

# run this script from the project root; a portable way of getting
# a script's path is hard to come by, so we assume .env is in the cwd

# -- includes --
. bin/prelude

# -- constants --
# the path of the game on itch (sans target)
ITCH_PATH="withpondlife/discone"

# -- props --
# the variant (e.g. playtest, release) if any; defaults to release
VARIANT=""

# -- parsing --
Usage() {
  pu "[-h] [-v <variant>]"
}

while getopts ":h" option; do
  case "${option}" in
    h*) Usage ;;
  esac
done

# -- commands --
# deploy each build in the dir at path; assumes the child name is the butler
# target name
Deploy() {
  # validate version
  version_file=$(realpath VERSION)

  # switch to the build dir
  cd "$BUILD" || exit 99

  # tag channel with variant, unless release
  tag=""
  if [ "$VARIANT" != "$VARIANT_RELEASE" ]; then
    tag="-$VARIANT"
  fi

  # push butler build
  for target in *; do
    "$BUTLER_PATH" push \
      "$target" \
      "$ITCH_PATH$tag:$target" \
      "--userversion-file=$version_file"
  done
}

# -- main --
Main() {
  # load env
  LoadEnv

  # validate env
  if [ ! -f "$BUTLER_PATH" ]; then
    pf 2 "butler (.env->BUTLER_PATH) does not exist at '$BUTLER_PATH'"
  fi

  # validate args
  if [ -z "$VARIANT" ]; then
    VARIANT="$VARIANT_RELEASE"
  fi

  # find build
  FindBuild "$VARIANT"

  # run deploy
  Deploy
}

Main "$*"
